<!doctype html>

<html lang="en">    
<head>    
<meta charset="utf-8" />    
<meta name="viewport" content="width=device-width,initial-scale=1" />    
<title>Admin Panel — Crypto Training</title>    
<link rel="icon" href="/logo.png">    
<style>    
  :root{ --bg:#071024; --card:#062035; --accent:#06b6d4; --danger:#ef4444; color-scheme: dark; }    
  body{ margin:0; font-family:system-ui,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,#031025,#071024); color:#e6eef8 }    
  header{ display:flex; align-items:center; gap:12px; padding:14px; background:linear-gradient(90deg,#06203a,#08304d) }    
  .logo{ height:36px }    
  .container{ padding:18px; max-width:1100px; margin:18px auto }    
  .row{ display:grid; grid-template-columns: repeat(auto-fit,minmax(300px,1fr)); gap:12px; margin-bottom:12px }    
  .card{ background:var(--card); padding:12px; border-radius:12px; box-shadow:0 8px 20px rgba(2,6,23,0.6) }    
  input,textarea,select{ width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit; box-sizing:border-box }    
  button{ padding:10px 12px; border-radius:8px; border:0; background:var(--accent); color:#042a2b; font-weight:700; cursor:pointer }    
  button.danger{ background:var(--danger); color:white }    
  table{ width:100%; border-collapse:collapse; margin-top:10px }    
  th,td{ padding:8px; border-bottom:1px solid rgba(255,255,255,0.04); text-align:left; font-size:13px }    
  .hint{ margin-top:8px; font-size:13px; opacity:0.9 }    
  .error { color: #ffb4b4; }    
  .ok { color: #baf7ff; }    
  .small-muted { font-size:12px; opacity:0.85; }    
  .modal-backdrop{ position:fixed; inset:0; background:rgba(2,6,23,0.6); display:none; align-items:center; justify-content:center; z-index:9999; }    
  .modal-panel{ background:#0b1220; padding:18px; border-radius:10px; width:96%; max-width:520px; box-shadow:0 12px 40px rgba(0,0,0,0.6); color:#e6eef8 }    
  .btn-small { padding:6px 8px; font-size:13px; border-radius:8px; }    
  .btn-muted { background:#6b7280; color:#fff; border:0; }    
</style>    
</head>    
<body>    
<header>    
  <img src="https://i.postimg.cc/x1cLbZhh/IMG-20250812-WA0070.jpg" class="logo" alt="logo">    
  <div><div style="font-weight:700">BEWISE TRADING AND INVESTMENT INSTITUTION</div></div>    
</header>    <div class="container" id="app">    
  <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:12px">    
    <div class="hint">Admin access is session-protected (cookie). You must login from / first.</div>    
    <div class="top-actions">    
      <button id="btnRefresh">Refresh</button>    
      <button id="btnLogout" class="danger">Logout</button>    
    </div>    
  </div>      <div class="row">    
    <div class="card">    
      <h3 style="margin:0 0 8px">Generate PIN</h3>    
      <label class="hint">Note (student name or email)</label>    
      <input id="noteInput" placeholder="e.g. John Doe / john@example.com">    
      <button id="btnGenerate">Generate 6-digit PIN</button>    
      <div id="generateResult" class="hint"></div>    
    </div>    <div class="card">    
  <h3 style="margin:0 0 8px">Upload Video</h3>    
  <label class="hint">Video Title</label>    
  <input id="videoTitle" placeholder="Lesson 1 - Intro">    
  <label class="hint">Video File</label>    
  <input id="videoFile" type="file" accept="video/*">    
  <button id="btnUpload">Upload Video</button>    
  <div id="uploadResult" class="hint"></div>    

  <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)">    

  <h4 style="margin:0 0 8px">Upload File (any file)</h4>    
  <label class="hint">File Title / Note</label>    
  <input id="fileTitle" placeholder="Resource name">    
  <label class="hint">File</label>    
  <input id="anyFile" type="file" accept="*/*">    
  <button id="btnUploadFile">Upload File</button>    
  <div id="uploadFileResult" class="hint"></div>    
</div>

  </div>      <div class="row">    
    <div class="card">    
      <h3 style="margin:0 0 8px">Active PINs</h3>    
      <div id="pinsArea">Loading pins...</div>    
    </div>    <div class="card">    
  <h3 style="margin:0 0 8px">Uploaded Videos</h3>    
  <div id="videosArea">Loading videos...</div>    
</div>

  </div>    
</div>    <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-hidden="true">    
  <div class="modal-panel">    
    <div id="modalTitle" style="font-weight:800;margin-bottom:8px">Title</div>    
    <div id="modalBody" style="margin-bottom:12px"></div>    
    <div style="text-align:right"><button id="modalOk" class="btn-small">OK</button></div>    
  </div>    
</div>    <script>    
(async function(){    
  const RENDER_HOST = 'bewise-trading-and-investment-institution-k7ue.onrender.com';    
  const RENDER_BASE = 'https://' + RENDER_HOST;    
  const RENDER_API = RENDER_BASE + '/api';    
  const API = (location.hostname === RENDER_HOST) ? '/api' : RENDER_API;    
  const UI_BASE = (location.hostname === RENDER_HOST) ? '' : RENDER_BASE;    
    
  const pinsArea = document.getElementById('pinsArea'), videosArea = document.getElementById('videosArea'),    
        btnGenerate = document.getElementById('btnGenerate'), noteInput = document.getElementById('noteInput'),    
        generateResult = document.getElementById('generateResult'), btnUpload = document.getElementById('btnUpload'),    
        videoTitle = document.getElementById('videoTitle'), videoFile = document.getElementById('videoFile'),    
        uploadResult = document.getElementById('uploadResult'), btnRefresh = document.getElementById('btnRefresh'),    
        btnLogout = document.getElementById('btnLogout'), btnUploadFile = document.getElementById('btnUploadFile'),    
        anyFile = document.getElementById('anyFile'), fileTitle = document.getElementById('fileTitle'),    
        uploadFileResult = document.getElementById('uploadFileResult');    
    
  const modalBackdrop = document.getElementById('modalBackdrop'), modalTitle = document.getElementById('modalTitle'), modalBody = document.getElementById('modalBody'), modalOk = document.getElementById('modalOk');    
    
  function showMessage(title, message){ 
    modalTitle.innerText = title; 
    // accept both strings and objects
    modalBody.innerText = (typeof message === 'string') ? message : JSON.stringify(message); 
    modalBackdrop.style.display = 'flex'; 
    return new Promise((res)=>{ modalOk.onclick = ()=>{ modalBackdrop.style.display='none'; res(true); }; }); 
  }    
    
  async function apiFetch(path, opts = {}){    
    const url = API + path;    
    const finalOpts = Object.assign({ credentials: 'include' }, opts);    
    try {    
      const res = await fetch(url, finalOpts);    
      if(res.status === 401 || res.status === 403){    
        await showMessage('Unauthorized', 'Session expired or not authorized. Redirecting to login.');    
        window.location.href = UI_BASE + '/';    
        throw new Error('unauthorized');    
      }    
      return res;    
    } catch(err){    
      console.error('apiFetch error', url, err); throw err;    
    }    
  }    
    
  async function checkSession(){    
    try{    
      const r = await apiFetch('/check_session');    
      const j = await r.json();    
      return j;    
    }catch(e){ return { logged_in:false }; }    
  }    
    
  const session = await checkSession();    
  if(!session.logged_in || !session.is_admin){    
    await showMessage('Admin required', 'Admin access requires you to login with admin PIN (811335) on this device first. Redirecting to login.');    
    window.location.href = UI_BASE + '/';    
    return;    
  }    
    
  async function loadPins(){    
    pinsArea.innerText = 'Loading pins...';    
    try {    
      const r = await apiFetch('/admin/pins');    
      const j = await r.json();    
      if(!Array.isArray(j)){ pinsArea.innerHTML = '<div class="error">Failed to load pins</div>'; return; }    
      const table = document.createElement('table');    
      table.innerHTML = '<thead><tr><th>ID</th><th>PIN</th><th>Note</th><th>Device</th><th>IP</th><th>Revoked</th><th>Action</th></tr></thead>';    
      const tbody = document.createElement('tbody');    
      j.forEach(p => {    
        const tr = document.createElement('tr');    
        tr.innerHTML = `<td>${p.id}</td><td>${p.pin}</td><td>${p.note||''}</td><td style="max-width:180px;word-break:break-word">${p.device_id||''}</td><td>${p.ip||''}</td><td>${p.revoked? 'YES':''}</td>`;    
        const td = document.createElement('td');    
    
        if(!p.revoked){    
          const btn = document.createElement('button');    
          btn.className = 'btn-small';    
          btn.innerText = 'Revoke';    
          btn.addEventListener('click', async ()=>{    
            const ok = confirm('Revoke PIN ' + p.pin + ' ?');    
            if(!ok) return;    
            btn.disabled = true;    
            try {    
              const rr = await apiFetch('/admin/revoke_pin', {    
                method:'POST',    
                headers: {'Content-Type':'application/json'},    
                body: JSON.stringify({ pin_id: p.id })    
              });    
              const jr = await rr.json();    
              if(rr.ok && jr.success){    
                await showMessage('Info','PIN revoked');    
                loadPins();    
              } else {    
                await showMessage('Error','Failed to revoke: ' + (jr.error || jr.message || 'server'));    
              }    
            } catch(err){ await showMessage('Network', 'Network error while revoking'); console.error(err); }    
            btn.disabled = false;    
          });    
          td.appendChild(btn);    
        } else {    
          const span = document.createElement('span'); span.innerText = '-'; td.appendChild(span);    
        }    
    
        const del = document.createElement('button'); del.className='btn-small btn-muted'; del.style.marginLeft='8px'; del.innerText='Delete';    
        del.addEventListener('click', async ()=>{    
          const ok = confirm('Delete PIN record?');    
          if(!ok) return;    
          del.disabled = true;    
          try {    
            const rr = await apiFetch('/admin/delete_pin', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ pin_id: p.id })});    
            if(rr.status === 404){    
              await showMessage('Error','Delete endpoint not available on server.');    
            } else {    
              const jr = await rr.json();    
              if(rr.ok && jr.success){ await showMessage('Info','Deleted'); loadPins(); } else { await showMessage('Error','Failed to delete: ' + (jr.error || jr.message || 'server')); }    
            }    
          } catch(err){ await showMessage('Network','Network error while deleting PIN'); console.error(err); }    
          del.disabled = false;    
        });    
        td.appendChild(del);    
    
        tr.appendChild(td);    
        tbody.appendChild(tr);    
      });    
      table.appendChild(tbody);    
      pinsArea.innerHTML = '';    
      pinsArea.appendChild(table);    
    } catch(e){ pinsArea.innerHTML = '<div class="error">Error loading pins</div>'; console.error('loadPins error', e); }    
  }    
    
  async function loadVideos(){    
    videosArea.innerText = 'Loading videos...';    
    try {    
      const r = await apiFetch('/videos');    
      const j = await r.json();    
      if(!Array.isArray(j)){ videosArea.innerHTML = '<div class="error">Failed to load videos</div>'; return; }    
      const table = document.createElement('table');    
      table.innerHTML = '<thead><tr><th>ID</th><th>Title</th><th>Uploaded</th><th>Action</th></tr></thead>';    
      const tbody = document.createElement('tbody');    
      j.forEach(v => {    
        const tr = document.createElement('tr');    
        tr.innerHTML = `<td>${v.id}</td><td>${v.title}</td><td>${v.uploaded_at||''}</td>`;    
        const td = document.createElement('td');    
        const del = document.createElement('button'); del.className='btn-small btn-muted'; del.innerText='Delete';    
        del.addEventListener('click', async ()=>{    
          const ok = confirm('Delete video "' + v.title + '" ?');    
          if(!ok) return;    
          del.disabled = true;    
          try {    
            const rr = await apiFetch('/admin/delete_video', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ video_id: v.id })});    
            if(rr.status === 404) await showMessage('Error','Delete endpoint not available on server.');    
            else {    
              const jr = await rr.json();    
              if(rr.ok && jr.success){ await showMessage('Info','Deleted'); loadVideos(); } else { await showMessage('Error','Failed to delete: ' + (jr.error || jr.message || 'server')); }    
            }    
          } catch(err){ await showMessage('Network','Network error while deleting video'); console.error(err); }    
          del.disabled = false;    
        });    
        td.appendChild(del);    
        tr.appendChild(td);    
        tbody.appendChild(tr);    
      });    
      table.appendChild(tbody);    
      videosArea.innerHTML = '';    
      videosArea.appendChild(table);    
    } catch(e){ videosArea.innerHTML = '<div class="error">Error loading videos</div>'; console.error('loadVideos error', e); }    
  }    
    
  btnGenerate.addEventListener('click', async ()=>{    
    const note = (noteInput.value || '').slice(0,200);    
    generateResult.innerText = 'Generating...';    
    btnGenerate.disabled = true;    
    try {    
      const r = await apiFetch('/admin/generate_pin', {    
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ note })    
      });    
      const j = await r.json();    
      if(r.ok && j.success){ generateResult.innerText = 'New PIN: ' + j.pin; noteInput.value=''; loadPins(); await showMessage('New PIN','New PIN: ' + j.pin); }    
      else { generateResult.innerText = 'Error: ' + (j.error || j.message || 'server'); await showMessage('Error','Failed to generate PIN: ' + (j.error || j.message || 'server')); }    
    } catch(e){ generateResult.innerText='Network error'; console.error('generate_pin error', e); await showMessage('Network','Network error'); }    
    btnGenerate.disabled = false;    
  });    
    
  // Helper: chunked upload for large files
  async function uploadLargeFile(file, title, onProgress = null) {
    // Keep chunk size safe (adjust if your host needs smaller)
    const CHUNK_SIZE = 8 * 1024 * 1024; // 8MB
    const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
    const uploadId = `${Date.now()}_${Math.random().toString(36).slice(2,10)}`;

    for (let i = 0; i < totalChunks; i++) {
      const start = i * CHUNK_SIZE;
      const end = Math.min((i + 1) * CHUNK_SIZE, file.size);
      const blob = file.slice(start, end);

      const fd = new FormData();
      fd.append('upload_id', uploadId);
      fd.append('filename', file.name);
      fd.append('chunk_index', i);
      fd.append('total_chunks', totalChunks);
      fd.append('chunk', blob, file.name);

      const res = await apiFetch('/admin/upload_video_chunk', { method: 'POST', body: fd });
      if (!res.ok) {
        // try to parse body for message
        let errJson = {};
        try { errJson = await res.json(); } catch(e){}
        throw new Error('Chunk upload failed: ' + (errJson.error || res.status));
      }
      const jr = await res.json();
      if (!jr.success) throw new Error('Chunk save failed: ' + (jr.error || JSON.stringify(jr)));

      if (typeof onProgress === 'function') {
        onProgress({ uploadedChunks: i + 1, totalChunks });
      }
    }

    // finalize
    const finishRes = await apiFetch('/admin/finish_video_upload', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ upload_id: uploadId, filename: file.name, title })
    });
    if (!finishRes.ok) {
      let errJson = {};
      try { errJson = await finishRes.json(); } catch(e){}
      throw new Error('Finalize failed: ' + (errJson.error || finishRes.status));
    }
    const finishJson = await finishRes.json();
    if (!finishJson.success) throw new Error('Finalize failed: ' + (finishJson.error || JSON.stringify(finishJson)));
    return finishJson;
  }

  btnUpload.addEventListener('click', async ()=>{    
    const title = (videoTitle.value || '').trim(); const file = videoFile.files[0];    
    if(!title || !file){ uploadResult.innerText='Provide title and file'; await showMessage('Missing','Provide title and file'); return; }    
    uploadResult.innerText='Uploading...'; btnUpload.disabled=true;    
    try {
      // If file is small enough, try direct upload first. Otherwise preemptively chunk.
      const SINGLE_UPLOAD_LIMIT = 100 * 1024 * 1024; // 100MB threshold; keep it consistent with your host limits
      if (file.size <= SINGLE_UPLOAD_LIMIT) {
        const fd = new FormData(); fd.append('title', title); fd.append('video', file);
        const r = await apiFetch('/admin/upload_video', { method:'POST', body: fd });
        // Handle 413 or server suggesting chunked upload
        if (r.status === 413) {
          // fallback to chunked
          uploadResult.innerText = 'Server rejected single upload. Switching to chunked upload...';
          const result = await uploadLargeFile(file, title, (p)=> {
            uploadResult.innerText = `Uploading chunks: ${p.uploadedChunks}/${p.totalChunks}`;
          });
          uploadResult.innerText = 'Uploaded ✓';
          videoTitle.value=''; videoFile.value=''; loadVideos();
          await showMessage('Uploaded','Video uploaded successfully (chunked).');
        } else {
          const j = await r.json();
          if (r.ok && j.success) {
            uploadResult.innerText='Uploaded ✓'; videoTitle.value=''; videoFile.value=''; loadVideos();
            await showMessage('Uploaded','Video uploaded successfully.');
          } else if (j && (j.error === 'file_too_large_for_single_request' || j.error === 'file_too_large')) {
            // server asked us to chunk
            uploadResult.innerText = 'Server asks for chunked upload. Uploading in chunks...';
            const result = await uploadLargeFile(file, title, (p)=> {
              uploadResult.innerText = `Uploading chunks: ${p.uploadedChunks}/${p.totalChunks}`;
            });
            uploadResult.innerText = 'Uploaded ✓';
            videoTitle.value=''; videoFile.value=''; loadVideos();
            await showMessage('Uploaded','Video uploaded successfully (chunked).');
          } else {
            uploadResult.innerText='Upload failed: ' + (j.error||j.message||'server'); await showMessage('Error','Upload failed: ' + (j.error||j.message||'server'));
          }
        }
      } else {
        // file too big — do chunked upload directly
        uploadResult.innerText = 'Uploading in chunks...';
        const result = await uploadLargeFile(file, title, (p)=> {
          uploadResult.innerText = `Uploading chunks: ${p.uploadedChunks}/${p.totalChunks}`;
        });
        uploadResult.innerText = 'Uploaded ✓';
        videoTitle.value=''; videoFile.value=''; loadVideos();
        await showMessage('Uploaded','Video uploaded successfully (chunked).');
      }
    } catch(e){
      console.error('upload_video error', e);
      uploadResult.innerText='Upload failed';
      await showMessage('Upload error', (e && e.message) ? e.message : 'Network error while uploading video');
    }    
    btnUpload.disabled=false;    
  });    
    
  btnUploadFile.addEventListener('click', async ()=>{    
    const title = (fileTitle.valu