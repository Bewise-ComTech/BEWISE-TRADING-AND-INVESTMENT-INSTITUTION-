<!doctype html>
<html>
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Courses — Crypto Training</title>
<link rel="icon" href=" https://i.postimg.cc/x1cLbZhh/IMG-20250812-WA0070.jpg  ">
<style>
  body{font-family:system-ui;margin:0;background:linear-gradient(180deg,#031025,#071024);color:#e6eef8}
  header{display:flex;align-items:center;gap:12px;padding:12px;background:linear-gradient(90deg,#06203a,#08304d);}
  .brand{ display:flex; align-items:center; gap:12px; }
  .logo{height:36px}
  .wrap{padding:18px;max-width:1100px;margin:auto}
  .intro{opacity:0.9;margin-bottom:14px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:14px}
  .card{background:#062035;padding:12px;border-radius:12px;position:relative;overflow:hidden}
  video{width:100%;border-radius:8px;background:black;display:block;min-height:160px}

  .precard {
    position:absolute; inset:12px; display:flex; align-items:center; justify-content:center; z-index:6;
    pointer-events:auto;
  }
  .precard .panel {
    width:100%; max-width:720px; background:linear-gradient(180deg,rgba(2,12,23,0.8),rgba(2,8,20,0.75)); border-radius:10px; padding:18px; text-align:center;
    box-shadow:0 10px 30px rgba(0,0,0,0.6);
  }
  .precard .title { font-weight:800; color:#baf7ff; margin-bottom:8px; font-size:1.05rem; }
  .precard .meta { color:#cfefff; opacity:0.9; font-size:13px; margin-bottom:12px; }
  .precard .play-btn {
    padding:10px 16px; border-radius:12px; border:0; font-weight:800; cursor:pointer;
    background:linear-gradient(90deg,#06b6d4,#0891b2); color:#042a2b; font-size:1rem;
  }

  .status { margin-top:8px; font-size:13px; color:#cfefff; opacity:0.95; }
  .status.error { color:#ffb4b4; }

  .vp-controls { display:flex; gap:8px; margin-top:8px; align-items:center; }
  .vp-btn { padding:8px 12px; border-radius:8px; border:0; cursor:pointer; font-weight:700; background:#06b6d4; color:#042a2b; }
  .vp-btn.pause { background:#ef4444; color:#fff; }

  .diagnose-btn { background:transparent; border:1px solid rgba(255,255,255,0.06); color:#cfefff; padding:6px 8px; border-radius:8px; cursor:pointer; }

  .debug-log { margin-top:8px; font-family:monospace; font-size:12px; color:#bfefff; white-space:pre-wrap; background:rgba(0,0,0,0.08); padding:8px; border-radius:8px; }

  @media (max-width:720px){
    .card{padding:10px}
    .precard .panel { padding:12px; }
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <img src=" https://i.postimg.cc/x1cLbZhh/IMG-20250812-WA0070.jpg" class="logo" alt="logo">
    <div style="font-weight:700">Courses</div>
  </div>
  <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
    <button id="topHelpBtn" class="vp-btn">Need Help?</button>
  </div>
</header>

<div class="wrap">
  <p class="intro">Watch course videos below. We do our best to prevent downloads; however, screen capture protection is limited in web browsers. If you experience playback issues, re-login from the main page.</p>
</div>

<div id="grid" class="grid" aria-live="polite"></div>

<!-- Modal (used only for re-login / critical errors) -->
<div id="modal" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.6);align-items:center;justify-content:center;z-index:9999;">
  <div style="background:#0b1220;padding:18px;border-radius:10px;width:92%;max-width:520px;color:#e6eef8">
    <div id="modalTitle" style="font-weight:800;margin-bottom:8px">Title</div>
    <div id="modalBody" style="margin-bottom:12px;color:#cfefff;"></div>
    <div style="text-align:right"><button id="modalOk" style="padding:8px 12px;border-radius:8px;border:0;background:#06b6d4;color:#042a2b;cursor:pointer">OK</button></div>
  </div>
</div>

<script>
(async function(){
  function showModal(title,msg){
    document.getElementById('modalTitle').innerText = title;
    document.getElementById('modalBody').innerText = msg;
    const modal = document.getElementById('modal');
    modal.style.display = 'flex';
    return new Promise(res => { document.getElementById('modalOk').onclick = ()=>{ modal.style.display='none'; res(true); }; });
  }

  // fingerprint/device lock (unchanged)
  async function computeFP(){
    let uuid = localStorage.getItem('training_device_uuid');
    if(!uuid){ uuid = crypto.randomUUID ? crypto.randomUUID() : ('u-'+Math.random().toString(36).slice(2)); localStorage.setItem('training_device_uuid', uuid); }
    const data = [navigator.userAgent||'', navigator.platform||'', (navigator.languages||[]).join(','), screen.width+'x'+screen.height+'x'+screen.colorDepth, Intl.DateTimeFormat().resolvedOptions().timeZone||'', uuid].join('||');
    const enc = new TextEncoder().encode(data);
    const hashBuf = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(hashBuf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  const fp = await computeFP();
  const allowed = localStorage.getItem('training_allowed_device');
  if(allowed && allowed !== fp){
    await showModal('Device locked','This installation is locked to another device. Please login from the registered device or contact admin.');
    location.href='/'; return;
  }

  // session check on load
  try {
    const chk = await (await fetch('/api/check_session', { credentials:'include' })).json();
    if(!chk.logged_in){ location.href='/'; return; }
  } catch(e){
    console.error('check_session failed', e);
    await showModal('Error','Unable to verify session. Redirecting to login.'); location.href='/'; return;
  }

  // load videos
  async function loadVideos(){
    try {
      const r = await fetch('/api/videos', { credentials:'include' });
      if(!r.ok) return [];
      return await r.json();
    } catch(e){
      console.error('loadVideos failed', e);
      return [];
    }
  }

  // request signed token/url (server validates session)
  async function requestSignedUrl(videoId){
    try {
      const r = await fetch('/api/video_token/' + videoId, { credentials:'include' });
      if(r.status === 401) return { ok:false, status:401 };
      if(!r.ok) return { ok:false, status: r.status, body: await r.text() };
      const j = await r.json();
      return { ok:true, url: j.url, token: j.token };
    } catch(e){
      console.error('requestSignedUrl failed', e);
      return { ok:false, error:e };
    }
  }

  // quick Range-check of signed URL to validate access before wiring <video>
  // uses Range: bytes=0-0 to prompt a 206 or 200 and prevent false "missing" errors.
  async function checkSignedUrlReachable(signedUrl){
    try {
      const r = await fetch(signedUrl, {
        method: 'GET',
        headers: { 'Range': 'bytes=0-0' },
        // no credentials needed for signed URLs
      });
      const out = { status: r.status, ok: r.ok, headers: {} };
      out.headers['Content-Type'] = r.headers.get('Content-Type');
      out.headers['Content-Range'] = r.headers.get('Content-Range');
      out.headers['Accept-Ranges'] = r.headers.get('Accept-Ranges');
      return out;
    } catch (e) {
      console.error('checkSignedUrlReachable failed', e);
      return { ok:false, error: e };
    }
  }

  // helper: more informative log formatting
  function fmtHeaders(h){
    let o = [];
    for(const k of ['Content-Type','Content-Range','Accept-Ranges']){
      if(h[k]) o.push(`${k}: ${h[k]}`);
    }
    return o.join('\\n') || '(no headers)';
  }

  // pre-card + playback with robust verification & a single safe refresh retry
  const grid = document.getElementById('grid');

  const videos = await loadVideos();
  if(!videos.length){
    grid.innerHTML = '<div style="opacity:0.8">No videos yet. Admin will upload lessons here.</div>';
  } else {
    grid.innerHTML = '';
    const ORIGIN = location.origin;
    videos.forEach(v=>{
      const card = document.createElement('div'); card.className = 'card';
      card.style.position = 'relative';

      const vid = document.createElement('video');
      vid.controls = true; vid.preload = 'metadata';
      vid.setAttribute('controlsList','nodownload nofullscreen noremoteplayback');
      vid.style.display = 'block';
      vid.setAttribute('playsinline','');

      // status area
      const status = document.createElement('div'); status.className = 'status';
      status.style.marginTop = '8px';

      // small controls
      const controls = document.createElement('div'); controls.className = 'vp-controls';
      const smallPlay = document.createElement('button'); smallPlay.className='vp-btn'; smallPlay.textContent='Play';
      const pauseBtn = document.createElement('button'); pauseBtn.className='vp-btn pause'; pauseBtn.textContent='Pause'; pauseBtn.style.display='none';
      const diagnoseBtn = document.createElement('button'); diagnoseBtn.className='diagnose-btn'; diagnoseBtn.textContent='Diagnose';
      controls.appendChild(smallPlay); controls.appendChild(pauseBtn); controls.appendChild(diagnoseBtn);

      smallPlay.addEventListener('click', async ()=>{ await precardPlay(); });
      pauseBtn.addEventListener('click', ()=>{ try{ vid.pause(); }catch(e){} });

      vid.addEventListener('play', ()=>{ smallPlay.style.display='none'; pauseBtn.style.display='inline-block'; });
      vid.addEventListener('pause', ()=>{ pauseBtn.style.display='none'; smallPlay.style.display='inline-block'; });

      // Pre-card overlay
      const precard = document.createElement('div'); precard.className = 'precard';
      const panel = document.createElement('div'); panel.className = 'panel';
      const title = document.createElement('div'); title.className = 'title'; title.innerText = v.title || 'Untitled';
      const meta = document.createElement('div'); meta.className = 'meta'; meta.innerText = 'Uploaded: ' + (v.uploaded_at || 'unknown');
      const bigPlay = document.createElement('button'); bigPlay.className = 'play-btn'; bigPlay.innerText = 'Play';
      panel.appendChild(title); panel.appendChild(meta); panel.appendChild(bigPlay);
      precard.appendChild(panel);

      // debug area (hidden by default; filled by Diagnose)
      const debugLog = document.createElement('div'); debugLog.className = 'debug-log'; debugLog.style.display='none';

      bigPlay.addEventListener('click', precardPlay);
      smallPlay.addEventListener('click', precardPlay);

      // Diagnose button: runs /api/video_token and a Range GET on the signed URL and prints the outcome
      diagnoseBtn.addEventListener('click', async ()=>{
        debugLog.style.display='block';
        debugLog.innerText = 'Running diagnostic...\\n';
        const tokenRes = await requestSignedUrl(v.id);
        if(!tokenRes.ok){
          debugLog.innerText += `token request failed: status=${tokenRes.status || 'network'}\\n`;
          if(tokenRes.status === 401) debugLog.innerText += '-> token endpoint returned 401: session invalid. Please login.\\n';
          return;
        }
        debugLog.innerText += `token OK. token present. URL: ${tokenRes.url}\\n`;
        const signedUrl = ORIGIN + tokenRes.url;
        debugLog.innerText += `signed URL (testing Range GET bytes=0-0)...\\n`;
        const chk = await checkSignedUrlReachable(signedUrl);
        if(chk.ok){
          debugLog.innerText += `Range GET status=${chk.status}\\n${fmtHeaders(chk.headers)}\\n`;
          if(chk.status === 206 || chk.status === 200){
            debugLog.innerText += 'Result: stream reachable — should play fine.\\n';
          } else {
            debugLog.innerText += 'Result: unexpected status for Range GET.\\n';
          }
        } else {
          debugLog.innerText += `Range GET failed: ${chk.status || 'network'}\\n${chk.error ? chk.error.toString() : ''}\\n`;
        }
      });

      async function precardPlay(){
        if(vid._starting) return;
        vid._starting = true;
        vid._errorRetries = 0;
        status.classList.remove('error'); status.innerText = 'Preparing playback...';
        // 1) get token
        let tokenRes = await requestSignedUrl(v.id);
        if(!tokenRes.ok){
          if(tokenRes.status === 401){
            await showModal('Login required','Please login again to watch videos. Redirecting to login.');
            location.href = '/'; return;
          }
          status.classList.add('error'); status.innerText = 'Failed to get playback token. Try re-login.';
          vid._starting = false; return;
        }
        // 2) check signed url reachability with Range GET
        const signedUrl = ORIGIN + tokenRes.url;
        let chk = await checkSignedUrlReachable(signedUrl);
        if(!chk.ok || !(chk.status === 206 || chk.status === 200)){
          // do one safe retry: request a fresh token and re-check (handles transient races)
          status.classList.add('note'); status.innerText = 'Initial stream check failed; trying a fresh token...';
          tokenRes = await requestSignedUrl(v.id);
          if(!tokenRes.ok){
            if(tokenRes.status === 401){
              await showModal('Login required','Please login again to watch videos. Redirecting to login.');
              location.href = '/'; return;
            }
            status.classList.add('error'); status.innerText = 'Failed to refresh playback token.';
            vid._starting = false; return;
          }
          const signed2 = ORIGIN + tokenRes.url;
          chk = await checkSignedUrlReachable(signed2);
          if(!chk.ok || !(chk.status === 206 || chk.status === 200)){
            // definitive failure
            if(chk.status === 404){
              status.classList.add('error'); status.innerText = 'Video missing on server.';
            } else if(chk.status === 401){
              await showModal('Login required','Please login again to watch videos. Redirecting to login.');
              location.href = '/'; return;
            } else {
              status.classList.add('error'); status.innerText = `Playback unavailable (status ${chk.status || 'network'}).`;
            }
            vid._starting = false; return;
          } else {
            // great — use this signed2
            await startPlaybackWithUrl(signed2, vid, status);
            vid._starting = false; return;
          }
        } else {
          // first signed URL OK
          await startPlaybackWithUrl(signedUrl, vid, status);
          vid._starting = false; return;
        }
      }

      // helper to set src, load and attempt to play
      async function startPlaybackWithUrl(signedUrl, videoEl, statusEl){
        try {
          statusEl.classList.remove('error'); statusEl.innerText = 'Starting playback...';
          // remove old src/hls
          try { if(videoEl._hls){ videoEl._hls.destroy(); videoEl._hls = null; } } catch(e){}
          try { if(videoEl.src && videoEl.src.startsWith('blob:')) URL.revokeObjectURL(videoEl.src); } catch(e){}
          videoEl.pause();
          videoEl.removeAttribute('src');
          videoEl.load();
          // assign new src and load to make player ready
          videoEl.src = signedUrl;
          // call load then user-gesture play (we're in click handler)
          videoEl.load();
          await videoEl.play();
          statusEl.innerText = '';
        } catch (err) {
          console.warn('startPlaybackWithUrl: play() failed', err);
          // In case play() fails, show a friendly inline hint but attempt one recovery via re-requesting token (only when precard play)
          statusEl.classList.add('error');
          statusEl.innerText = 'Playback retry failed. Contact admin.';
        }
      }

      // resilient error handler for mid-playback errors: attempt single silent token refresh then retry
      vid._errorRetries = 0;
      vid.addEventListener('error', async (ev)=>{
        console.warn('video element error event', ev);
        if(vid._errorRetries >= 1){
          status.classList.add('error'); status.innerText = 'Playback failed. If this persists, use Diagnose and contact admin.';
          return;
        }
        vid._errorRetries += 1;
        status.classList.remove('error'); status.innerText = 'Playback error — attempting to refresh token and retry...';
        // request a new signed URL, check reachability and use if ok
        const tokenRes = await requestSignedUrl(v.id);
        if(!tokenRes.ok){
          if(tokenRes.status === 401){
            await showModal('Login required','Please login again to watch videos. Redirecting to login.');
            location.href = '/'; return;
          }
          status.classList.add('error'); status.innerText = 'Unable to refresh token. Contact admin.';
          return;
        }
        const signedUrl = ORIGIN + tokenRes.url;
        const chk = await checkSignedUrlReachable(signedUrl);
        if(chk.ok && (chk.status === 206 || chk.status === 200)){
          // apply new src and try to play
          try {
            try { if(vid._hls){ vid._hls.destroy(); vid._hls = null; } } catch(e){}
            vid.pause(); vid.removeAttribute('src'); vid.load();
            vid.src = signedUrl;
            vid.load();
            setTimeout(async ()=>{
              try{
                await vid.play();
                status.classList.remove('error'); status.classList.add('note'); status.innerText = 'Playback resumed after refresh.';
              } catch(e){
                console.warn('play after error-refresh failed', e);
                status.classList.add('error'); status.innerText = 'Playback retry failed. Contact admin.';
              }
            }, 200);
          } catch(e){
            console.error('apply new signed url failed', e);
            status.classList.add('error'); status.classList.add('error'); status.innerText = 'Playback retry failed. Contact admin.';
          }
        } else {
          if(chk.status === 404){
            status.classList.add('error'); status.innerText = 'Video missing on server.';
          } else if(chk.status === 401){
            await showModal('Login required','Please login again to watch videos. Redirecting to login.');
            location.href = '/'; return;
          } else {
            status.classList.add('error'); status.innerText = 'Playback retry failed (network).';
          }
        }
      });

      // assemble card
      card.appendChild(vid);
      card.appendChild(precard);
      card.appendChild(controls);
      card.appendChild(status);
      card.appendChild(debugLog);
      grid.appendChild(card);
    });
  }

  // top help
  document.getElementById('topHelpBtn').addEventListener('click', async ()=>{
    await showModal('Need help','If you need assistance, contact support or reach out to the admin.');
  });

  // UI polish
  document.addEventListener('contextmenu', e => {
    const el = e.target;
    if(el && (el.tagName === 'VIDEO' || (el.closest && el.closest('.card')))){
      e.preventDefault();
    }
  });

  document.addEventListener('visibilitychange', ()=>{ document.querySelectorAll('video').forEach(v=> v.style.filter = document.visibilityState === 'visible' ? 'none' : 'blur(6px)'); });

})();
</script>
</body>
</html>