<!doctype html>
<html>
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Courses — Crypto Training</title>
<link rel="icon" href=" https://i.postimg.cc/x1cLbZhh/IMG-20250812-WA0070.jpg  ">

<!-- hls.js -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.3/dist/hls.min.js"></script>

<style>
  body{font-family:system-ui;margin:0;background:linear-gradient(180deg,#031025,#071024);color:#e6eef8}
  header{display:flex;align-items:center;gap:12px;padding:12px;background:linear-gradient(90deg,#06203a,#08304d);}
  .brand{ display:flex; align-items:center; gap:12px; }
  .logo{height:36px}
  .wrap{padding:18px;max-width:1100px;margin:auto}
  .intro{opacity:0.9;margin-bottom:14px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:14px}
  .card{background:#062035;padding:12px;border-radius:12px;position:relative;overflow:hidden}
  video{width:100%;border-radius:8px;background:black;display:block;min-height:140px}
  .muted { opacity:0.85; font-size:13px; }
  .vp-controls { display:flex; gap:8px; margin-top:8px; align-items:center; }
  .vp-btn { padding:8px 12px; border-radius:8px; border:0; cursor:pointer; font-weight:700; background:#06b6d4; color:#042a2b; }
  .vp-btn.pause { background:#ef4444; color:#fff; }
  .err-block { background:#071424; padding:12px; border-radius:8px; margin-top:10px; color:#ffd0d0; }
  .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.06); color:#cfefff; padding:6px 8px; border-radius:6px; cursor:pointer; }
  @media (max-width:720px){ .card{ padding:10px } }
</style>
</head>
<body>
<header>
  <div class="brand">
    <img src=" https://i.postimg.cc/x1cLbZhh/IMG-20250812-WA0070.jpg" class="logo" alt="logo">
    <div style="font-weight:700">Courses</div>
  </div>
  <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
    <button id="topHelpBtn" class="vp-btn" aria-label="Help">Need Help?</button>
  </div>
</header>

<div class="wrap">
  <p class="intro">Watch course videos below. We do our best to prevent downloads; however, screen capture protection is limited in web browsers. If you experience playback issues, re-login from the main page.</p>
</div>

<div id="grid" class="grid" aria-live="polite"></div>

<!-- Modal -->
<div id="modalBackdrop" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.6);align-items:center;justify-content:center;z-index:9999;">
  <div style="background:#0b1220;padding:18px;border-radius:10px;width:92%;max-width:520px;color:#e6eef8">
    <div id="modalTitle" style="font-weight:800;margin-bottom:8px">Title</div>
    <div id="modalBody" style="margin-bottom:12px"></div>
    <div style="text-align:right"><button id="modalOk" class="btn-ghost">OK</button></div>
  </div>
</div>

<script>
(async function(){
  // small modal utils
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  const modalOk = document.getElementById('modalOk');
  function showModal(title, msg){
    modalTitle.innerText = title || '';
    modalBody.innerText = msg || '';
    modalBackdrop.style.display = 'flex';
    return new Promise(res => { modalOk.onclick = ()=>{ modalBackdrop.style.display='none'; res(true); }; });
  }

  // check session up front
  try {
    const chk = await (await fetch('/api/check_session', { credentials: 'include' })).json();
    if(!chk.logged_in){ await showModal('Login', 'Please login to access course videos. Redirecting.'); location.href='/'; return; }
  } catch(e){
    console.error('session check failed', e);
    await showModal('Error','Unable to verify session. Redirecting to login.'); location.href='/'; return;
  }

  // helper: safe json
  async function safeJson(url, opts){
    try {
      const r = await fetch(url, opts);
      if(!r.ok) return { ok:false, status:r.status };
      const j = await r.json();
      return { ok:true, body:j };
    } catch(e){ return { ok:false, error:e }; }
  }

  const grid = document.getElementById('grid');
  const ORIGIN = location.origin;

  // fetch videos
  const videosRes = await safeJson('/api/videos', { credentials: 'include' });
  const videos = (videosRes.ok && Array.isArray(videosRes.body)) ? videosRes.body : [];

  // track blob URLs
  const blobUrls = new Set();
  window.addEventListener('beforeunload', ()=> { for(const u of blobUrls) try{ URL.revokeObjectURL(u); }catch(e){} });

  function createControls(videoEl){
    const wrapper = document.createElement('div'); wrapper.className='vp-controls';
    const play = document.createElement('button'); play.className='vp-btn'; play.textContent='Play';
    const pause = document.createElement('button'); pause.className='vp-btn pause'; pause.textContent='Pause'; pause.style.display='none';
    play.onclick = async ()=> {
      try { await videoEl.play(); } catch(err){
        console.warn('play() failed, attempting fallback', err);
        await showModal('Playback issue','Attempting an alternative playback method. After the retry completes, press Play again.');
        // fallback will have already been wired on error handler — so user can press play again
      }
    };
    pause.onclick = ()=> { try{ videoEl.pause(); }catch(e){} };
    videoEl.addEventListener('play', ()=>{ play.style.display='none'; pause.style.display='inline-block'; });
    videoEl.addEventListener('pause', ()=>{ pause.style.display='none'; play.style.display='inline-block'; });
    wrapper.appendChild(play); wrapper.appendChild(pause);
    return wrapper;
  }

  async function tryFetchPlaylist(video_id){
    const url = ORIGIN + '/hls/' + video_id + '/index.m3u8';
    try {
      const r = await fetch(url, { method: 'GET', credentials: 'include' });
      return r;
    } catch(err){
      console.error('playlist fetch failed', err);
      return { ok:false, status:0 };
    }
  }

  async function fetchStreamAsBlob(videoEl, streamUrl){
    // attempt to fetch /stream/<id> as blob with cookies
    try {
      const r = await fetch(streamUrl, { credentials: 'include' });
      if(r.status === 401){
        // session issue
        return { ok:false, status:401 };
      }
      if(!r.ok) return { ok:false, status:r.status };
      const ct = r.headers.get('Content-Type') || 'video/mp4';
      const blob = await r.blob();
      const url = URL.createObjectURL(new Blob([blob], { type: ct }));
      blobUrls.add(url);
      videoEl.src = url;
      return { ok:true };
    } catch(e){
      console.error('fetchStreamAsBlob failed', e);
      return { ok:false, error:e };
    }
  }

  // render
  function render(){
    grid.innerHTML = '';
    if(!videos.length){
      grid.innerHTML = '<div style="opacity:0.8">No videos yet. Admin will upload lessons here.</div>';
      return;
    }

    videos.forEach(v => {
      const card = document.createElement('div'); card.className='card';
      const vid = document.createElement('video');
      vid.controls = true;
      vid.preload = 'metadata';
      vid.setAttribute('controlsList','nodownload nofullscreen noremoteplayback');
      vid.setAttribute('playsinline','');
      try { vid.crossOrigin = 'use-credentials'; } catch(e){}

      const info = document.createElement('div'); info.style.marginTop='8px'; info.style.fontWeight='700'; info.innerText = v.title || 'Untitled';

      const errBox = document.createElement('div'); errBox.className='err-block'; errBox.style.display='none';

      // helper to show error in card
      function showCardError(titleMsg, detailMsg, actionsHtml){
        errBox.innerHTML = `<div style="font-weight:800">${titleMsg}</div><div style="margin-top:6px">${detailMsg}</div>`;
        if(actionsHtml){
          const aWrap = document.createElement('div'); aWrap.style.marginTop='8px';
          aWrap.innerHTML = actionsHtml;
          errBox.appendChild(aWrap);
        }
        errBox.style.display = 'block';
      }

      // progress: first test HLS playlist
      (async ()=>{
        const playlistUrl = ORIGIN + '/hls/' + v.id + '/index.m3u8';
        const streamUrl = ORIGIN + '/stream/' + v.id;

        // check HLS playlist quickly
        const plResp = await tryFetchPlaylist(v.id);
        if(plResp && plResp.ok){
          // HLS exists — prefer it. Use hls.js when available to ensure credentials for segments
          if(window.Hls && Hls.isSupported()){
            const hls = new Hls({
              xhrSetup: function(xhr, url) {
                xhr.withCredentials = true;
              }
            });
            try {
              hls.loadSource(playlistUrl);
              hls.attachMedia(vid);
              vid._hls = hls;
              // attach an error handler
              hls.on(Hls.Events.ERROR, async (event, data)=>{
                console.warn('hls.js error', event, data);
                // try fallback to /stream/<id> blob
                const tried = await fetchStreamAsBlob(vid, streamUrl);
                if(tried.ok) {
                  errBox.style.display='none';
                } else if(tried.status === 401) {
                  showCardError('Playback failed','Please re-login to watch videos.','<button class="btn-ghost" id="relogin">Go to login</button>');
                  errBox.querySelector('#relogin').onclick = ()=> location.href='/';
                } else {
                  showCardError('Playback failed','Unable to play this video. Please re-login or contact admin.','<button class="btn-ghost" id="retry">Retry</button>');
                  errBox.querySelector('#retry').onclick = ()=> location.reload();
                }
              });
            } catch(err){
              console.warn('hls attach failed, falling back', err);
              // fallback to stream
              const fallbackResult = await fetchStreamAsBlob(vid, streamUrl);
              if(!fallbackResult.ok){
                if(fallbackResult.status === 401){
                  showCardError('Login required','Please re-login to watch videos.','<button class="btn-ghost" id="relogin">Login</button>');
                  errBox.querySelector('#relogin').onclick = ()=> location.href='/';
                } else if(fallbackResult.status === 404){
                  showCardError('Video missing','Video doesn\\'t exist. Refresh the page or contact admin.','<button class="btn-ghost" id="refresh">Refresh</button>');
                  errBox.querySelector('#refresh').onclick = ()=> location.reload();
                } else {
                  showCardError('Playback failed','Unable to play this video. Please re-login or contact admin.','<button class="btn-ghost" id="retry">Retry</button>');
                  errBox.querySelector('#retry').onclick = ()=> location.reload();
                }
              }
            }
          } else {
            // Native HLS likely (iOS). Assign src directly.
            vid.src = playlistUrl;
            // add error handler; if native HLS fails, attempt blob fallback
            vid.addEventListener('error', async ()=>{
              const tried = await fetchStreamAsBlob(vid, streamUrl);
              if(!tried.ok){
                if(tried.status === 401){
                  showCardError('Login required','Please re-login to watch videos.','<button class="btn-ghost" id="relogin">Login</button>');
                  errBox.querySelector('#relogin').onclick = ()=> location.href='/';
                } else {
                  showCardError('Playback failed','Unable to play this video. Please re-login or contact admin.','<button class="btn-ghost" id="retry">Retry</button>');
                  errBox.querySelector('#retry').onclick = ()=> location.reload();
                }
              }
            }, { once: true });
          }
          return;
        }

        // playlist missing or fetch failed => try original stream route via blob fetch
        if(plResp && plResp.status === 404){
          // HLS not generated; attempt direct stream blob
          const blobRes = await fetchStreamAsBlob(vid, streamUrl);
          if(blobRes.ok){
            errBox.style.display='none';
            return;
          }
          if(blobRes.status === 401){
            showCardError('Login required','Please re-login to watch videos.','<button class="btn-ghost" id="relogin">Login</button>');
            errBox.querySelector('#relogin').onclick = ()=> location.href='/';
            return;
          }
          if(blobRes.status === 404){
            showCardError('Video missing','Video doesn\\'t exist. Refresh the page or contact admin.','<button class="btn-ghost" id="refresh">Refresh</button>');
            errBox.querySelector('#refresh').onclick = ()=> location.reload();
            return;
          }
          // generic failure
          showCardError('Playback failed','Unable to play this video. Please re-login or contact admin.','<button class="btn-ghost" id="retry">Retry</button>');
          errBox.querySelector('#retry').onclick = ()=> location.reload();
          return;
        }

        // if plResp failed due to network/other status (e.g., 401)
        if(plResp && (plResp.status === 401 || plResp.status === 403)){
          showCardError('Login required','Please re-login to watch videos.','<button class="btn-ghost" id="relogin">Login</button>');
          errBox.querySelector('#relogin').onclick = ()=> location.href='/';
          return;
        }

        // fallback generic: try /stream/<id> blob
        const blobRes2 = await fetchStreamAsBlob(vid, streamUrl);
        if(blobRes2.ok) { errBox.style.display='none'; return; }
        if(blobRes2.status === 401){
          showCardError('Login required','Please re-login to watch videos.','<button class="btn-ghost" id="relogin">Login</button>');
          errBox.querySelector('#relogin').onclick = ()=> location.href='/';
        } else if(blobRes2.status === 404){
          showCardError('Video missing','Video doesn\\'t exist. Refresh the page or contact admin.','<button class="btn-ghost" id="refresh">Refresh</button>');
          errBox.querySelector('#refresh').onclick = ()=> location.reload();
        } else {
          showCardError('Playback failed','Unable to play this video. Please re-login or contact admin.','<button class="btn-ghost" id="retry">Retry</button>');
          errBox.querySelector('#retry').onclick = ()=> location.reload();
        }
      })();

      // final assembly
      card.appendChild(vid);
      card.appendChild(createControls(vid));
      card.appendChild(info);
      card.appendChild(errBox);
      grid.appendChild(card);
    });
  }

  render();

  // top help
  document.getElementById('topHelpBtn').addEventListener('click', async ()=>{
    await showModal('Need help','If you need assistance, contact support or reach out to the admin. We are here to help you learn.');
  });

})();
</script>
</body>
</html>