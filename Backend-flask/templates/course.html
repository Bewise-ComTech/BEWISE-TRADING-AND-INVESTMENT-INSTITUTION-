<!doctype html>
<html>
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Courses — Crypto Training</title>
<link rel="icon" href=" https://i.postimg.cc/x1cLbZhh/IMG-20250812-WA0070.jpg  ">

<style>
  body{font-family:system-ui;margin:0;background:linear-gradient(180deg,#031025,#071024);color:#e6eef8}
  header{display:flex;align-items:center;gap:12px;padding:12px;background:linear-gradient(90deg,#06203a,#08304d);}
  .brand{ display:flex; align-items:center; gap:12px; }
  .logo{height:36px}
  .wrap{padding:18px;max-width:1100px;margin:auto}
  .intro{opacity:0.9;margin-bottom:14px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:14px}
  .card{background:#062035;padding:12px;border-radius:12px;position:relative;overflow:hidden}
  video{width:100%;border-radius:8px;background:black;display:block;min-height:160px}

  .precard {
    position:absolute; inset:12px; display:flex; align-items:center; justify-content:center; z-index:6;
    pointer-events:auto;
  }
  .precard .panel {
    width:100%; max-width:720px; background:linear-gradient(180deg,rgba(2,12,23,0.8),rgba(2,8,20,0.75)); border-radius:10px; padding:18px; text-align:center;
    box-shadow:0 10px 30px rgba(0,0,0,0.6);
  }
  .precard .title { font-weight:800; color:#baf7ff; margin-bottom:8px; font-size:1.05rem; }
  .precard .meta { color:#cfefff; opacity:0.9; font-size:13px; margin-bottom:12px; }
  .precard .play-btn {
    padding:10px 16px; border-radius:12px; border:0; font-weight:800; cursor:pointer;
    background:linear-gradient(90deg,#06b6d4,#0891b2); color:#042a2b; font-size:1rem;
  }

  .status { margin-top:8px; font-size:13px; color:#cfefff; opacity:0.95; }
  .status.error { color:#ffb4b4; }

  .vp-controls { display:flex; gap:8px; margin-top:8px; align-items:center; }
  .vp-btn { padding:8px 12px; border-radius:8px; border:0; cursor:pointer; font-weight:700; background:#06b6d4; color:#042a2b; }
  .vp-btn.pause { background:#ef4444; color:#fff; }

  @media (max-width:720px){
    .card{padding:10px}
    .precard .panel { padding:12px; }
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <img src=" https://i.postimg.cc/x1cLbZhh/IMG-20250812-WA0070.jpg" class="logo" alt="logo">
    <div style="font-weight:700">Courses</div>
  </div>
  <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
    <button id="topHelpBtn" class="vp-btn">Need Help?</button>
  </div>
</header>

<div class="wrap">
  <p class="intro">Watch course videos below. We do our best to prevent downloads; however, screen capture protection is limited in web browsers. If you experience playback issues, re-login from the main page.</p>
</div>

<div id="grid" class="grid" aria-live="polite"></div>

<!-- Modal (used only for re-login / critical errors) -->
<div id="modal" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.6);align-items:center;justify-content:center;z-index:9999;">
  <div style="background:#0b1220;padding:18px;border-radius:10px;width:92%;max-width:520px;color:#e6eef8">
    <div id="modalTitle" style="font-weight:800;margin-bottom:8px">Title</div>
    <div id="modalBody" style="margin-bottom:12px;color:#cfefff;"></div>
    <div style="text-align:right"><button id="modalOk" style="padding:8px 12px;border-radius:8px;border:0;background:#06b6d4;color:#042a2b;cursor:pointer">OK</button></div>
  </div>
</div>

<script>
(async function(){
  function showModal(title,msg){
    document.getElementById('modalTitle').innerText = title;
    document.getElementById('modalBody').innerText = msg;
    const modal = document.getElementById('modal');
    modal.style.display = 'flex';
    return new Promise(res => { document.getElementById('modalOk').onclick = ()=>{ modal.style.display='none'; res(true); }; });
  }

  // fingerprint/device lock (unchanged)
  async function computeFP(){
    let uuid = localStorage.getItem('training_device_uuid');
    if(!uuid){ uuid = crypto.randomUUID ? crypto.randomUUID() : ('u-'+Math.random().toString(36).slice(2)); localStorage.setItem('training_device_uuid', uuid); }
    const data = [navigator.userAgent||'', navigator.platform||'', (navigator.languages||[]).join(','), screen.width+'x'+screen.height+'x'+screen.colorDepth, Intl.DateTimeFormat().resolvedOptions().timeZone||'', uuid].join('||');
    const enc = new TextEncoder().encode(data);
    const hashBuf = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(hashBuf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  const fp = await computeFP();
  const allowed = localStorage.getItem('training_allowed_device');
  if(allowed && allowed !== fp){
    await showModal('Device locked','This installation is locked to another device. Please login from the registered device or contact admin.');
    location.href='/'; return;
  }

  // session check on load
  try {
    const chk = await (await fetch('/api/check_session', { credentials:'include' })).json();
    if(!chk.logged_in){ location.href='/'; return; }
  } catch(e){
    console.error('check_session failed', e);
    await showModal('Error','Unable to verify session. Redirecting to login.'); location.href='/'; return;
  }

  // load videos
  async function loadVideos(){
    try {
      const r = await fetch('/api/videos', { credentials:'include' });
      if(!r.ok) return [];
      return await r.json();
    } catch(e){
      console.error('loadVideos failed', e);
      return [];
    }
  }

  // request signed token/url (server validates session)
  async function requestSignedUrl(videoId){
    try {
      const r = await fetch('/api/video_token/' + videoId, { credentials:'include' });
      if(r.status === 401) return { ok:false, status:401 };
      if(!r.ok) return { ok:false, status: r.status, body: await r.text() };
      const j = await r.json();
      return { ok:true, url: j.url, token: j.token };
    } catch(e){
      console.error('requestSignedUrl failed', e);
      return { ok:false, error:e };
    }
  }

  // pre-card + playback
  const grid = document.getElementById('grid');

  const videos = await loadVideos();
  if(!videos.length){
    grid.innerHTML = '<div style="opacity:0.8">No videos yet. Admin will upload lessons here.</div>';
  } else {
    grid.innerHTML = '';
    const ORIGIN = location.origin;
    videos.forEach(v=>{
      const card = document.createElement('div'); card.className = 'card';
      card.style.position = 'relative';

      const vid = document.createElement('video');
      vid.controls = true; vid.preload = 'metadata';
      vid.setAttribute('controlsList','nodownload nofullscreen noremoteplayback');
      vid.style.display = 'block';
      vid.setAttribute('playsinline','');

      // status area
      const status = document.createElement('div'); status.className = 'status';
      status.style.marginTop = '8px';

      // small controls (play/pause) left in place; but playback initiation uses pre-card
      const controls = document.createElement('div'); controls.className = 'vp-controls';
      const playBtn = document.createElement('button'); playBtn.className='vp-btn'; playBtn.textContent='Play';
      const pauseBtn = document.createElement('button'); pauseBtn.className='vp-btn pause'; pauseBtn.textContent='Pause'; pauseBtn.style.display='none';
      controls.appendChild(playBtn); controls.appendChild(pauseBtn);

      playBtn.addEventListener('click', async ()=>{
        await precardPlay();
      });
      pauseBtn.addEventListener('click', ()=>{ try{ vid.pause(); }catch(e){} });

      vid.addEventListener('play', ()=>{ playBtn.style.display='none'; pauseBtn.style.display='inline-block'; });
      vid.addEventListener('pause', ()=>{ pauseBtn.style.display='none'; playBtn.style.display='inline-block'; });

      // Pre-card overlay
      const precard = document.createElement('div'); precard.className = 'precard';
      const panel = document.createElement('div'); panel.className = 'panel';
      const title = document.createElement('div'); title.className = 'title'; title.innerText = v.title || 'Untitled';
      const meta = document.createElement('div'); meta.className = 'meta'; meta.innerText = 'Uploaded: ' + (v.uploaded_at || 'unknown');
      const bigPlay = document.createElement('button'); bigPlay.className = 'play-btn'; bigPlay.innerText = 'Play';
      panel.appendChild(title); panel.appendChild(meta); panel.appendChild(bigPlay);
      precard.appendChild(panel);

      // attach click handlers to pre-card and small play
      bigPlay.addEventListener('click', precardPlay);

      async function precardPlay(){
        // guard
        if(vid._starting) return;
        vid._starting = true;
        status.classList.remove('error'); status.innerText = 'Preparing playback...';
        // request signed token from server (server checks session)
        const tokenRes = await requestSignedUrl(v.id);
        if(!tokenRes.ok){
          if(tokenRes.status === 401){
            // session invalid -> require re-login
            await showModal('Login required','Please login again to watch videos. Redirecting to login.');
            location.href = '/';
            return;
          }
          status.classList.add('error');
          status.innerText = 'Failed to get playback URL (status: ' + (tokenRes.status || 'network') + ').';
          vid._starting = false;
          return;
        }
        // set video.src to signed URL (absolute)
        const signedUrl = ORIGIN + tokenRes.url;
        // Clear any existing Hls or blob src
        try { if(vid._hls){ vid._hls.destroy(); vid._hls = null; } } catch(e){}
        try { URL.revokeObjectURL(vid.src); } catch(e){}
        vid.removeAttribute('src');
        // Assign signed URL directly — Range streaming will be used (no cookies necessary)
        vid.src = signedUrl;
        // hide precard overlay
        precard.style.display = 'none';
        status.innerText = 'Starting playback...';
        try{
          await vid.play();
          // success
          status.innerText = '';
        } catch(e){
          console.warn('Auto-play failed, user gesture required', e);
          status.innerText = '';
        } finally {
          vid._starting = false;
        }
      }

      // attach error handler for clear messages
      vid.addEventListener('error', async (ev)=>{
        console.warn('video element error', ev);
        // best attempt to surface meaningful info: try a HEAD/GET to signed stream to see status
        const dataSrc = vid.src || vid.getAttribute('data-src');
        if(dataSrc){
          try {
            const r = await fetch(dataSrc, { method:'HEAD' });
            if(r.status === 401){
              await showModal('Login required','Please login to watch this video. Redirecting to login.');
              location.href='/'; return;
            }
            if(r.status === 404){
              status.classList.add('error'); status.innerText = 'Video missing on server.';
              return;
            }
            status.classList.add('error'); status.innerText = 'Playback failed. Contact admin.';
          } catch(e){
            console.error('error diagnostic failed', e);
            status.classList.add('error'); status.innerText = 'Playback failed (network).';
          }
        } else {
          status.classList.add('error'); status.innerText = 'Playback failed.';
        }
      });

      // assemble card
      card.appendChild(vid);
      card.appendChild(precard);
      card.appendChild(controls);
      card.appendChild(status);
      grid.appendChild(card);
    });
  }

  // top help
  document.getElementById('topHelpBtn').addEventListener('click', async ()=>{
    await showModal('Need help','If you need assistance, contact support or reach out to the admin.');
  });

  // UI polish
  document.addEventListener('contextmenu', e => {
    const el = e.target;
    if(el && (el.tagName === 'VIDEO' || (el.closest && el.closest('.card')))){
      e.preventDefault();
    }
  });

  document.addEventListener('visibilitychange', ()=>{ document.querySelectorAll('video').forEach(v=> v.style.filter = document.visibilityState === 'visible' ? 'none' : 'blur(6px)'); });

})();
</script>
</body>
</html>