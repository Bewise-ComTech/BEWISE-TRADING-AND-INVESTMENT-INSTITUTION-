<!doctype html>
<html>
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Courses â€” Crypto Training</title>
<link rel="icon" href=" https://i.postimg.cc/x1cLbZhh/IMG-20250812-WA0070.jpg  ">
<style>
  body{font-family:system-ui;margin:0;background:linear-gradient(180deg,#031025,#071024);color:#e6eef8}
  header{
    display:flex;
    align-items:center;
    gap:12px;
    padding:12px;
    background:linear-gradient(90deg,#06203a,#08304d);
  }
  .brand{ display:flex; align-items:center; gap:12px; }
  .logo{height:36px}
  .wrap{padding:18px;max-width:1100px;margin:auto}
  .intro{opacity:0.9;margin-bottom:14px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:14px}
  .card{background:#062035;padding:12px;border-radius:12px;position:relative;overflow:hidden}
  video{width:100%;border-radius:8px;background:black;display:block}

  /* top-right button styling */
  .header-actions{ margin-left:auto; display:flex; gap:8px; align-items:center; }
  .top-btn{
    padding:8px 12px;
    border-radius:10px;
    border:0;
    cursor:pointer;
    font-weight:800;
    font-size:0.95rem;
    background:linear-gradient(90deg,#06b6d4,#0891b2);
    color:#042a2b;
    box-shadow:0 8px 20px rgba(0,0,0,0.35);
  }
  .top-btn.secondary{ background:linear-gradient(90deg,#4ade80,#16a34a); color:#04210b; }

  /* encouragement sections */
  .encourage-wrap{ display:grid; grid-template-columns: 120px 1fr; gap:12px; align-items:flex-start; margin:16px 0; background:linear-gradient(180deg,#041324,#02101a); padding:14px; border-radius:12px; box-shadow:0 8px 18px rgba(0,0,0,0.45); }
  .encourage-img{ width:110px; height:110px; object-fit:cover; border-radius:10px; border:2px solid rgba(255,255,255,0.04); }
  .encourage-text{ font-size:15px; line-height:1.5; color:#dff8ff; }
  .encourage-title{ font-weight:800; margin-bottom:8px; color:#bff7ff; }

  /* modal */
  .modal-backdrop{ position:fixed; inset:0; background:rgba(2,6,23,0.6); display:none; align-items:center; justify-content:center; z-index:9999; }
  .modal-panel{ background:#0b1220; padding:18px; border-radius:10px; width:92%; max-width:520px; box-shadow:0 12px 40px rgba(0,0,0,0.6); color:#e6eef8 }
  .modal-title{ font-weight:800; margin-bottom:8px; font-size:1.05rem }
  .modal-body{ margin-bottom:12px; color:#cfefff; line-height:1.3 }
  .modal-actions{ display:flex; gap:8px; justify-content:flex-end; }
  .btn-secondary{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:#cfefff; padding:8px 10px; border-radius:8px; cursor:pointer }
  .btn-primary{ background:linear-gradient(90deg,#06b6d4,#0891b2); color:#042a2b; padding:8px 12px; border-radius:8px; font-weight:800; cursor:pointer }

  /* play/pause controls */
  .vp-controls { display:flex; gap:8px; margin-top:8px; align-items:center; }
  .vp-btn { padding:8px 12px; border-radius:8px; border:0; cursor:pointer; font-weight:700; background:#06b6d4; color:#042a2b; }
  .vp-btn.pause { background:#ef4444; color:#fff; }

  @media (max-width:720px){
    .encourage-wrap{ grid-template-columns: 1fr; }
    .encourage-img{ width:100%; height:180px; }
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <img src=" https://i.postimg.cc/x1cLbZhh/IMG-20250812-WA0070.jpg" class="logo" alt="logo">
    <div style="font-weight:700">Courses</div>
  </div>

  <!-- Top-right button -->
  <div class="header-actions">

    <button id="topHelpBtn" class="top-btn secondary" aria-label="Help">Need Help?</button>
  </div>
</header>

<div class="wrap">
  <p class="intro">Watch course videos below. We do our best to prevent downloads; however, screen capture protection is limited in web browsers. If you experience playback issues, re-login from the main page.</p>


  </div>

  <!-- Grid of videos -->
  <div id="grid" class="grid" aria-live="polite"></div>
</div>

<!-- Modal (used instead of alerts) -->
<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-hidden="true">
  <div class="modal-panel" role="document" aria-live="polite" aria-modal="true">
    <div class="modal-title" id="modalTitle">Title</div>
    <div class="modal-body" id="modalBody">Message</div>
    <div class="modal-actions" id="modalActions">
      <button class="btn-secondary" id="modalCancel">Cancel</button>
      <button class="btn-primary" id="modalOk">OK</button>
    </div>
  </div>
</div>

<script>
(async function(){
  // Modal utilities (replaces alert)
  const backdrop = document.getElementById('modalBackdrop');
  const titleEl = document.getElementById('modalTitle');
  const bodyEl = document.getElementById('modalBody');
  const okBtn = document.getElementById('modalOk');
  const cancelBtn = document.getElementById('modalCancel');
  function showModal(title, message, { showCancel=false, okText='OK', cancelText='Cancel' } = {}){
    titleEl.innerText = title || '';
    bodyEl.innerText = message || '';
    okBtn.innerText = okText;
    cancelBtn.innerText = cancelText;
    cancelBtn.style.display = showCancel ? 'inline-block' : 'none';
    backdrop.style.display = 'flex';
    backdrop.setAttribute('aria-hidden','false');
    return new Promise(resolve=>{
      function cleanup(){ okBtn.removeEventListener('click', onOk); cancelBtn.removeEventListener('click', onCancel); backdrop.style.display='none'; backdrop.setAttribute('aria-hidden','true'); }
      function onOk(){ cleanup(); resolve(true); }
      function onCancel(){ cleanup(); resolve(false); }
      okBtn.addEventListener('click', onOk);
      cancelBtn.addEventListener('click', onCancel);
    });
  }
  const showMessage = (t,m) => showModal(t,m,{showCancel:false,okText:'OK'});

  // compute fingerprint and optional local lock check
  async function computeFP(){
    let uuid = localStorage.getItem('training_device_uuid');
    if(!uuid){ uuid = crypto.randomUUID ? crypto.randomUUID() : ('u-'+Math.random().toString(36).slice(2)); localStorage.setItem('training_device_uuid', uuid); }
    const data = [navigator.userAgent||'', navigator.platform||'', (navigator.languages||[]).join(','), screen.width+'x'+screen.height+'x'+screen.colorDepth, Intl.DateTimeFormat().resolvedOptions().timeZone||'', uuid].join('||');
    const enc = new TextEncoder().encode(data);
    const hashBuf = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(hashBuf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  const fp = await computeFP();
  const allowed = localStorage.getItem('training_allowed_device');
  if(allowed && allowed !== fp){
    await showMessage('Device locked','This installation is locked to another device. Please login from the registered device or contact admin.');
    location.href='/'; return;
  }

  // ensure session active
  try{
    const chk = await (await fetch('/api/check_session', {credentials:'include'})).json();
    if(!chk.logged_in){ location.href='/'; return; }
  }catch(e){
    console.error('check_session failed',e);
    await showMessage('Error','Unable to verify session. Redirecting to login.'); location.href='/'; return;
  }

  // helper to fetch JSON safely
  async function safeJson(url, opts){ try { const r = await fetch(url, opts); if(!r.ok){ return {ok:false,status:r.status}; } const j = await r.json(); return {ok:true,body:j}; } catch(e){ return {ok:false,error:e}; } }

  // UI refs
  const grid = document.getElementById('grid');
  const topHelpBtn = document.getElementById('topHelpBtn');

  // track blob URLs to revoke later
  const createdObjectUrls = new Set();

  // fallback: fetch video as blob and set object URL (used only when direct <video src> fails)
  async function fetchVideoBlobToSrc(videoEl, streamPath) {
    try {
      const resp = await fetch(streamPath, { credentials: 'include' });
      if(!resp.ok) throw new Error('Fetch failed: ' + resp.status);
      const contentType = resp.headers.get('Content-Type') || 'video/mp4';
      const blob = await resp.blob();
      const url = URL.createObjectURL(new Blob([blob], { type: contentType }));
      createdObjectUrls.add(url);
      videoEl.src = url;
      // DO NOT auto-play. User must press Play (gesture).
      return true;
    } catch (err) {
      console.error('fetchVideoBlobToSrc failed', err);
      return false;
    }
  }

  // load videos from backend and render
  async function loadVideos(){
    const res = await safeJson('/api/videos', { credentials: 'include' });
    if(res.ok && Array.isArray(res.body)) return res.body;
    return [];
  }

  function createVPButtons(videoEl){
    const wrapper = document.createElement('div');
    wrapper.className = 'vp-controls';

    const playBtn = document.createElement('button');
    playBtn.className = 'vp-btn play';
    playBtn.type = 'button';
    playBtn.innerText = 'Play';

    const pauseBtn = document.createElement('button');
    pauseBtn.className = 'vp-btn pause';
    pauseBtn.type = 'button';
    pauseBtn.innerText = 'Pause';
    pauseBtn.style.display = 'none';

    playBtn.addEventListener('click', async ()=>{
      try {
        await videoEl.play();
      } catch (err) {
        // If play fails because the source isn't playable, try the blob fallback
        console.warn('play() failed, attempting blob fallback', err);
        await showMessage('Playback issue','Attempting an alternative playback method. After the retry completes, press Play again.');
        const ok = await fetchVideoBlobToSrc(videoEl, videoEl.getAttribute('data-src'));
        if(!ok) await showMessage('Playback failed','Unable to play this video. Please re-login or contact admin.');
      }
    });

    pauseBtn.addEventListener('click', ()=>{
      try { videoEl.pause(); } catch(e){ /* ignore */ }
    });

    // update button visibility on play/pause events
    videoEl.addEventListener('play', ()=>{ playBtn.style.display='none'; pauseBtn.style.display='inline-block'; });
    videoEl.addEventListener('pause', ()=>{ pauseBtn.style.display='none'; playBtn.style.display='inline-block'; });
    videoEl.addEventListener('ended', ()=>{ pauseBtn.style.display='none'; playBtn.style.display='inline-block'; });

    wrapper.appendChild(playBtn);
    wrapper.appendChild(pauseBtn);
    return wrapper;
  }

  function renderVideos(videos){
    grid.innerHTML = '';
    if(!Array.isArray(videos) || videos.length===0){
      grid.innerHTML = '<div style="opacity:0.8">No videos yet. Admin will upload lessons here.</div>'; return;
    }

    // compute origin base for absolute stream URLs
    const ORIGIN_BASE = location.origin;

    videos.forEach(v=>{
      const card = document.createElement('div'); card.className='card';
      const vid = document.createElement('video');
      vid.controls = true;
      vid.setAttribute('controlsList','nodownload nofullscreen noremoteplayback');
      vid.preload = 'metadata';
      vid.setAttribute('playsinline', ''); // help mobile playback
      // ensure browser sends cookies for the media requests (needed when backend requires session cookie)
      try { vid.crossOrigin = 'use-credentials'; } catch(e) { /* ignore if not supported */ }

      // keep original stream path in data attribute (for fallback)
      const streamPath = ORIGIN_BASE + '/stream/' + v.id;
      vid.setAttribute('data-src', streamPath);
      // video source: absolute stream route from backend so cookies and CORS behave correctly
      vid.src = streamPath;

      // on play verify session is still active (same as before)
      vid.addEventListener('play', async function onPlay(){
        try {
          const r = await fetch('/api/check_session', {credentials:'include'});
          if(!r.ok){ vid.pause(); await showMessage('Login required','Please login again to watch videos.'); location.href='/'; return; }
          const j = await r.json();
          if(!j.logged_in){ vid.pause(); await showMessage('Login required','Please login again to watch videos.'); location.href='/'; return; }
        } catch(e){
          vid.pause();
          await showMessage('Error','Session check failed. Redirecting to login.'); location.href='/'; return;
        } finally {
          vid.removeEventListener('play', onPlay);
        }
      });

      // If browser reports an error on the video element, attempt blob fallback once
      let triedFallback = false;
      vid.addEventListener('error', async (ev) => {
        console.warn('video element error event', ev);
        if(triedFallback) return;
        triedFallback = true;
        await showMessage('Playback issue','Automatic retry: attempting alternative playback method (may take a few seconds). After the retry completes, press Play again.');
        const ok = await fetchVideoBlobToSrc(vid, streamPath);
        if(!ok){
          await showMessage('Playback failed','Unable to play this video. Try re-logging or contact admin.');
        }
      });

      // hinder right click/save
      vid.addEventListener('contextmenu', e => e.preventDefault());

      const t = document.createElement('div'); t.style.marginTop='8px'; t.style.fontWeight='700'; t.innerText = v.title || 'Untitled';

      card.appendChild(vid);
      // play/pause buttons
      const controls = createVPButtons(vid);
      card.appendChild(controls);

      card.appendChild(t); grid.appendChild(card);
    });
  }

  // initial load
  const videos = await loadVideos();
  renderVideos(videos);

  // top-right button minimal behaviors
  topHelpBtn.addEventListener('click', async ()=>{
    await showMessage('Need help','If you need assistance, contact support or reach out to the admin. We are here to help you learn.');
  });

  // UX protections & polish
  document.addEventListener('contextmenu', e => {
    const el = e.target;
    if(el && (el.tagName === 'VIDEO' || (el.closest && el.closest('.card')))){
      e.preventDefault();
    }
  });

  // Blur videos when page hidden
  document.addEventListener('visibilitychange', ()=>{ document.querySelectorAll('video').forEach(v=> v.style.filter = document.visibilityState === 'visible' ? 'none' : 'blur(6px)'); });

  // revoke created object URLs when leaving
  window.addEventListener('beforeunload', ()=>{
    for(const u of createdObjectUrls) try{ URL.revokeObjectURL(u);}catch(e){}
  });

})();
</script>
</body>
</html>